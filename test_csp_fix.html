<!DOCTYPE html>
<html>
<head>
    <title>StashAI CSP Fix Test</title>
    <meta charset="utf-8">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .status-success { color: #28a745; }
        .status-error { color: #dc3545; }
        .status-warning { color: #ffc107; }
        .endpoint-test { 
            margin: 10px 0; 
            padding: 15px; 
            border: 1px solid #ddd; 
            border-radius: 5px; 
        }
        .result { 
            margin-top: 10px; 
            padding: 10px; 
            background: #f8f9fa; 
            border-radius: 3px; 
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h1>üß™ StashAI CSP Fix Verification</h1>
        <p>This page tests that the StashAI proxy server successfully resolves Content Security Policy violations.</p>

        <div class="alert alert-info">
            <strong>Testing from:</strong> <span id="current-origin"></span><br>
            <strong>Proxy Server:</strong> http://localhost:10000<br>
            <strong>Expected Result:</strong> All API calls should work without CSP errors
        </div>

        <div class="row">
            <div class="col-md-6">
                <div class="endpoint-test">
                    <h5>‚úÖ Proxy Health Check</h5>
                    <p>Tests the proxy server itself</p>
                    <button class="btn btn-primary" onclick="testProxyHealth()">Test /proxy/health</button>
                    <div id="proxy-result" class="result"></div>
                </div>
            </div>

            <div class="col-md-6">
                <div class="endpoint-test">
                    <h5>üß† StashAI Health Check</h5>
                    <p>Tests StashAI Server through proxy (CSP compliant)</p>
                    <button class="btn btn-success" onclick="testStashAIHealth()">Test /stash-ai/api/v1/health</button>
                    <div id="stashai-result" class="result"></div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-6">
                <div class="endpoint-test">
                    <h5>üö´ Direct API Call (Should Fail)</h5>
                    <p>Tests direct call to StashAI (should trigger CSP violation)</p>
                    <button class="btn btn-danger" onclick="testDirectCall()">Test http://localhost:8080/api/v1/health</button>
                    <div id="direct-result" class="result"></div>
                </div>
            </div>

            <div class="col-md-6">
                <div class="endpoint-test">
                    <h5>üéØ Plugin Integration Test</h5>
                    <p>Simulates the actual plugin behavior</p>
                    <button class="btn btn-info" onclick="testPluginBehavior()">Test Plugin Simulation</button>
                    <div id="plugin-result" class="result"></div>
                </div>
            </div>
        </div>

        <div class="mt-4">
            <button class="btn btn-warning btn-lg" onclick="runAllTests()">üß™ Run All Tests</button>
        </div>

        <div class="mt-4">
            <h3>Test Results Summary</h3>
            <div id="summary" class="alert alert-light">
                Click "Run All Tests" to see results
            </div>
        </div>
    </div>

    <script>
        document.getElementById('current-origin').textContent = window.location.origin;
        
        let testResults = {};

        async function testProxyHealth() {
            const resultDiv = document.getElementById('proxy-result');
            try {
                resultDiv.innerHTML = '<span class="text-info">Testing...</span>';
                const response = await fetch('/proxy/health');
                const data = await response.json();
                
                if (response.ok) {
                    resultDiv.innerHTML = `<span class="status-success">‚úÖ SUCCESS</span><br>Status: ${data.status}<br>Uptime: ${Math.round(data.uptime)}s`;
                    testResults.proxy = true;
                } else {
                    resultDiv.innerHTML = `<span class="status-error">‚ùå HTTP ${response.status}</span>`;
                    testResults.proxy = false;
                }
            } catch (error) {
                resultDiv.innerHTML = `<span class="status-error">‚ùå ERROR: ${error.message}</span>`;
                testResults.proxy = false;
            }
        }

        async function testStashAIHealth() {
            const resultDiv = document.getElementById('stashai-result');
            try {
                resultDiv.innerHTML = '<span class="text-info">Testing...</span>';
                const response = await fetch('/stash-ai/api/v1/health');
                const data = await response.json();
                
                if (response.ok && data.success) {
                    resultDiv.innerHTML = `<span class="status-success">‚úÖ SUCCESS - No CSP Violation!</span><br>Service: ${data.service_name}<br>Status: ${data.status}<br>Version: ${data.version}`;
                    testResults.stashAI = true;
                } else {
                    resultDiv.innerHTML = `<span class="status-error">‚ùå API Error</span><br>${data.message || 'Unknown error'}`;
                    testResults.stashAI = false;
                }
            } catch (error) {
                resultDiv.innerHTML = `<span class="status-error">‚ùå ERROR: ${error.message}</span>`;
                testResults.stashAI = false;
            }
        }

        async function testDirectCall() {
            const resultDiv = document.getElementById('direct-result');
            try {
                resultDiv.innerHTML = '<span class="text-info">Testing...</span>';
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 5000);
                
                const response = await fetch('http://localhost:8080/api/v1/health', {
                    signal: controller.signal
                });
                clearTimeout(timeoutId);
                
                // If this succeeds, it means CSP is not enforced or disabled
                resultDiv.innerHTML = `<span class="status-warning">‚ö†Ô∏è UNEXPECTED SUCCESS</span><br>Direct call worked - CSP may not be enforced`;
                testResults.direct = 'unexpected_success';
            } catch (error) {
                if (error.message.includes('Content Security Policy') || error.message.includes('Refused to connect')) {
                    resultDiv.innerHTML = `<span class="status-success">‚úÖ EXPECTED CSP VIOLATION</span><br>This proves CSP is working correctly`;
                    testResults.direct = true;
                } else {
                    resultDiv.innerHTML = `<span class="status-error">‚ùå OTHER ERROR: ${error.message}</span>`;
                    testResults.direct = false;
                }
            }
        }

        async function testPluginBehavior() {
            const resultDiv = document.getElementById('plugin-result');
            try {
                resultDiv.innerHTML = '<span class="text-info">Simulating plugin behavior...</span>';
                
                // Simulate the plugin's useRelativeUrl=true behavior
                const response = await fetch('/stash-ai/api/v1/health', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    resultDiv.innerHTML = `<span class="status-success">‚úÖ PLUGIN SIMULATION SUCCESS</span><br>Plugin would work correctly with relative URLs<br>Response: ${data.service_name} v${data.version}`;
                    testResults.plugin = true;
                } else {
                    resultDiv.innerHTML = `<span class="status-error">‚ùå Plugin simulation failed</span>`;
                    testResults.plugin = false;
                }
            } catch (error) {
                resultDiv.innerHTML = `<span class="status-error">‚ùå ERROR: ${error.message}</span>`;
                testResults.plugin = false;
            }
        }

        async function runAllTests() {
            testResults = {};
            await Promise.all([
                testProxyHealth(),
                testStashAIHealth(),
                testDirectCall(),
                testPluginBehavior()
            ]);
            
            updateSummary();
        }

        function updateSummary() {
            const summaryDiv = document.getElementById('summary');
            const total = Object.keys(testResults).length;
            const passed = Object.values(testResults).filter(result => result === true).length;
            const warnings = Object.values(testResults).filter(result => result === 'unexpected_success').length;
            
            let summaryHTML = `<h4>Results: ${passed}/${total} tests passed`;
            if (warnings > 0) summaryHTML += ` (${warnings} warnings)`;
            summaryHTML += `</h4>`;
            
            if (testResults.proxy && testResults.stashAI && testResults.plugin) {
                summaryHTML += `<div class="alert alert-success mt-2">
                    <strong>üéâ CSP Fix Working Perfectly!</strong><br>
                    ‚Ä¢ Proxy server is healthy<br>
                    ‚Ä¢ StashAI APIs work through proxy<br>
                    ‚Ä¢ Plugin simulation successful<br>
                    ‚Ä¢ ${testResults.direct === true ? 'CSP properly blocks direct calls' : 'Direct call behavior as expected'}
                </div>`;
            } else {
                summaryHTML += `<div class="alert alert-warning mt-2">
                    <strong>‚ö†Ô∏è Some tests failed</strong><br>
                    Check individual test results above for details.
                </div>`;
            }
            
            summaryDiv.innerHTML = summaryHTML;
        }

        // Auto-run basic tests on page load
        setTimeout(() => {
            testProxyHealth();
            testStashAIHealth();
        }, 1000);
    </script>
</body>
</html>