<!DOCTYPE html>
<html>
<head>
    <title>StashAI Plugin Integration Test</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
</head>
<body>
    <div class="container mt-4">
        <h1>üß† StashAI Plugin Integration Test</h1>
        <p>This page simulates the Stash plugin environment to test our StashAI integration.</p>
        
        <div class="alert alert-info">
            <strong>Status:</strong> 
            <span id="server-status">Checking StashAI Server connection...</span>
        </div>
        
        <div id="plugin-container"></div>
    </div>

    <script>
        // Mock PluginApi for testing
        window.PluginApi = {
            React: React,
            libraries: {
                Bootstrap: {
                    Button: ({ onClick, children, style, disabled }) => 
                        React.createElement('button', {
                            className: 'btn btn-primary',
                            onClick,
                            style,
                            disabled
                        }, children)
                }
            },
            components: {
                Setting: ({ heading, children }) => 
                    React.createElement('div', { className: 'card mb-3' }, [
                        React.createElement('div', { className: 'card-header', key: 'header' }, heading),
                        React.createElement('div', { className: 'card-body', key: 'body' }, children)
                    ])
            },
            patch: {
                before: (target, fn) => {
                    console.log(`Mock patch.before called for ${target}`);
                    // For testing, we'll manually render the component
                    const result = fn({ children: null });
                    if (result && result.length > 0) {
                        const container = document.getElementById('plugin-container');
                        ReactDOM.render(result[0].children, container);
                    }
                }
            }
        };

        // Test StashAI Server connection
        async function testConnection() {
            try {
                // Test the CSP-compliant proxy endpoint
                const response = await fetch('/stash-ai/api/v1/health');
                const data = await response.json();
                document.getElementById('server-status').innerHTML = 
                    `‚úÖ Connected via proxy to ${data.service_name} v${data.version} - Status: ${data.status}`;
                document.getElementById('server-status').className = 'text-success';
            } catch (error) {
                // Fallback to direct connection for testing
                try {
                    const directResponse = await fetch('http://localhost:8080/api/v1/health');
                    const directData = await directResponse.json();
                    document.getElementById('server-status').innerHTML = 
                        `‚ö†Ô∏è Direct connection works, but proxy failed: ${error.message}`;
                    document.getElementById('server-status').className = 'text-warning';
                } catch (directError) {
                    document.getElementById('server-status').innerHTML = 
                        `‚ùå Both proxy and direct connection failed: ${error.message}`;
                    document.getElementById('server-status').className = 'text-danger';
                }
            }
        }

        // Test connection on page load
        testConnection();
    </script>

    <!-- Load our compiled AISettings component -->
    <script src="dist/AISettings.js"></script>
</body>
</html>